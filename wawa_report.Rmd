---
title: "Wawa"
author: "Alice Walsh"
date: "6/15/2019"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include=FALSE}
library(ggplot2)
library(ggmap)
library(dplyr)
```

```{r}
# Load in data previously generated by '01_wawadata.R', '03_osmdata.R'
wawa_df <- readRDS('data/wawa_df.Rds')
osm_df <- readRDS('data/osm_df.Rds')

# Have col names lat state city in both
wawa_osm <- cbind(rename(wawa_df, lat_wawa = lat, lon_wawa = long, state_ab = state), 
                  rename(osm_df, osm_city = city))

wawa_osm$maxspeed_num <- as.numeric(gsub(" mph","",wawa_osm$maxspeed))
wawa_osm$lanes_num <- as.numeric(wawa_osm$lanes)
```

# New Wawa in Glenside

## Motivation
Goodman Properties is planning a Wawa with gas (“Super Wawa”) at the corner of Easton Road and Waverly Road in Glenside, PA.

Concerns from neighbors and the community were raised about safety, traffic, and the juxtaposition with smaller scale properties and businesses in the area.

There are also two other Wawa locations already in close proximity.

* Are other Super Wawa locations in similar areas?
* Are other Super Wawa locations this close to other Wawas?

## Step 1: Query data on Wawa locations in Northeast

Retrieved the Wawa locations from wawa.com for the area around Glenside, PA. *Retrieved data on 485 unique Wawa locations (PA, NJ, DE, MD).*
Wawa.com data does not include detailed information on location size, number of pumps, etc.

* 470/485 Wawa locations are open 24 hours
* 280/485 Wawa locations have gas
* 280/485 Wawa locations have restrooms

Here is a map of all the locations in the dataset:

```{r}

mapdf <- wawa_df[,c("long","lat")]
mapdf$new <- c(rep("exists",nrow(wawa_df)-1),"new")

# getting the map
mapgilbert <- get_map(location = c(lon = mean(mapdf$long), lat = mean(mapdf$lat)), zoom = 8,
                      maptype = "hybrid", scale = 2)

# plotting the map with some points on it
ggmap(mapgilbert) +
  geom_point(data = mapdf, aes(x = long, y = lat, fill = new, alpha = 0.9), size = 2, shape = 21) +
  guides(fill=FALSE, alpha=FALSE, size=FALSE)

```

### Proposed new Wawa site
The proposed Wawa is at [200 S Easton Rd.](https://www.google.com/maps/place/200+S+Easton+Rd,+Glenside,+PA+19038/@40.0986321,-75.1580774,17z/data=!3m1!4b1!4m5!3m4!1s0x89c6ba0ab50e862d:0xda87770daaf8ea23!8m2!3d40.098628!4d-75.1558834)

```{r}
# ZOOM in on new wawa
new_wawa <- data.frame(long = c(-75.155848, -75.155848-0.005, -75.155848+0.005),
                       lat = c(40.098564, 40.098564-0.005, 40.098564+0.005))
map_new <- get_map(location = c(lon = new_wawa$long[1], lat = new_wawa$lat[2]), zoom = 15,
                      maptype = "hybrid", scale = 2)

# plotting the map with some points on it
ggmap(map_new) +
  geom_point(data = new_wawa, aes(x = long, y = lat, fill = "red", alpha = 0.9), size = 2, shape = 21) +
  guides(fill=FALSE, alpha=FALSE, size=FALSE) + 
  scale_y_continuous(limits = c(40.098564-0.005, 40.098564+0.005)) +
  scale_x_continuous(limits = c(-75.155848-0.005, -75.155848+0.005)) +
  NULL

```

## Step 2: Annotate Wawa locations with data from OpenStreetMaps

1. Retrieve number of lanes and max speed limit of road (can we do this better with other data source???)

+ May be misleading because nearest road might be a driveway or side road off of a major highway
+ Lanes and speed are not available for most Wawa coordinates
+ Also counted the number of motorways in a set area around wawa location (https://wiki.openstreetmap.org/wiki/Key:highway)

2. Count the number of houses in set area around Wawa location

+ Not all buildings are on openstreetmaps - we need a better data source

3. Calculate the distance to the nearest Wawa and the number of Wawa locations within a set area

## Results: The new Wawa will be close to other Wawa locations

The distance to the nearest Wawa from each Wawa location was calculated in meters. The shortest distance between the Wawa coordinates was calculated according to the 'Vincenty (ellipsoid)' method as implemented in the 'geosphere' R package.

```{r}
new_dist <- wawa_df$min_dist_wawa[wawa_df$storeName=="NEW"]
```

The closest Wawa to the proposed location will be `r new_dist` meters from the nearest Wawa. That is `r new_dist/1609.34` miles.

The median distance between locations is `r median(wawa_df$min_dist_wawa[-486])` meters.

```{r}
wawa_df %>% filter(state %in% c("NJ","PA")) %>% 
  ggplot(aes(x=fuel, y=min_dist_wawa/1609.34)) + 
  geom_hline(yintercept = new_dist/1609.34, color="red", linetype = 2) + 
  geom_boxplot(outlier.shape = NA) + geom_jitter(height = 0, width = 0.2, alpha=0.5) + 
  facet_wrap(~state) +
  ylim(c(0,10)) +
  labs(title = "Distance to nearest Wawa", 
       subtitle = "Dotted red line shows proposed Wawa",
       y="Distance (miles)", x="Does the Wawa have gas?")+
  theme_minimal()
```


## Results: Most Wawa locations with gas are on higher speed roads

This is imperfect because the OpenStreetMap data was missing for some roads and the roads might be a driveway or service road off a larger (higher speed) road.

```{r}
wawa_osm %>% filter(state_ab %in% c("NJ","PA")) %>% 
  ggplot(aes(y = maxspeed_num, x=fuel)) + 
  geom_hline(yintercept = 25, color="red", linetype = 2) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(height = 0, width = 0.2, alpha=0.5) + 
  facet_wrap(~state_ab) +
  labs(title = "Speed Limits", 
       subtitle = "Dotted red line shows proposed Wawa",
       y="Max Speed Limit (mph)", x="Does the Wawa have gas?")+
  theme_minimal()
```

